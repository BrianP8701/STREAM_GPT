{
    "metadata": {
        "type": "web",
        "url": "https://docs.llamaindex.ai/en/stable/examples/query_engine/recursive_retriever_agents.html",
        "title": "Recursive Retriever + Document Agents - LlamaIndex \ud83e\udd99 0.8.49",
        "description": null
    },
    "text": "[Back to top](#)\n\nToggle table of contents sidebar\n\nThis guide shows how to combine recursive retrieval and \u201cdocument agents\u201d for advanced decision making over heterogeneous documents.\n\nThere are two motivating factors that lead to solutions for better retrieval:\n\n*   Decoupling retrieval embeddings from chunk-based synthesis. Oftentimes fetching documents by their summaries will return more relevant context to queries rather than raw chunks. This is something that recursive retrieval directly allows.\n    \n*   Within a document, users may need to dynamically perform tasks beyond fact-based question-answering. We introduce the concept of \u201cdocument agents\u201d - agents that have access to both vector search and summary tools for a given document.\n    \n\n## Setup and Download Data[\uf0c1](#setup-and-download-data \"Permalink to this heading\")\n\nIn this section, we\u2019ll define imports and then download Wikipedia articles about different cities. Each article is stored separately.\n\nfrom llama\\_index import (\n    VectorStoreIndex,\n    SummaryIndex,\n    SimpleKeywordTableIndex,\n    SimpleDirectoryReader,\n    ServiceContext,\n)\nfrom llama\\_index.schema import IndexNode\nfrom llama\\_index.tools import QueryEngineTool, ToolMetadata\nfrom llama\\_index.llms import OpenAI\n\nwiki\\_titles \\= \\[\"Toronto\", \"Seattle\", \"Chicago\", \"Boston\", \"Houston\"\\]\n\nfrom pathlib import Path\n\nimport requests\n\nfor title in wiki\\_titles:\n    response \\= requests.get(\n        \"https://en.wikipedia.org/w/api.php\",\n        params\\={\n            \"action\": \"query\",\n            \"format\": \"json\",\n            \"titles\": title,\n            \"prop\": \"extracts\",\n            \\# 'exintro': True,\n            \"explaintext\": True,\n        },\n    ).json()\n    page \\= next(iter(response\\[\"query\"\\]\\[\"pages\"\\].values()))\n    wiki\\_text \\= page\\[\"extract\"\\]\n\n    data\\_path \\= Path(\"data\")\n    if not data\\_path.exists():\n        Path.mkdir(data\\_path)\n\n    with open(data\\_path / f\"{title}.txt\", \"w\") as fp:\n        fp.write(wiki\\_text)\n\n\\# Load all wiki documents\ncity\\_docs \\= {}\nfor wiki\\_title in wiki\\_titles:\n    city\\_docs\\[wiki\\_title\\] \\= SimpleDirectoryReader(\n        input\\_files\\=\\[f\"data/{wiki\\_title}.txt\"\\]\n    ).load\\_data()\n\nDefine LLM + Service Context + Callback Manager\n\nllm \\= OpenAI(temperature\\=0, model\\=\"gpt-3.5-turbo\")\nservice\\_context \\= ServiceContext.from\\_defaults(llm\\=llm)\n\n## Build Document Agent for each Document[\uf0c1](#build-document-agent-for-each-document \"Permalink to this heading\")\n\nIn this section we define \u201cdocument agents\u201d for each document.\n\nFirst we define both a vector index (for semantic search) and summary index (for summarization) for each document. The two query engines are then converted into tools that are passed to an OpenAI function calling agent.\n\nThis document agent can dynamically choose to perform semantic search or summarization within a given document.\n\nWe create a separate document agent for each city.\n\nfrom llama\\_index.agent import OpenAIAgent\n\n\\# Build agents dictionary\nagents \\= {}\n\nfor wiki\\_title in wiki\\_titles:\n    \\# build vector index\n    vector\\_index \\= VectorStoreIndex.from\\_documents(\n        city\\_docs\\[wiki\\_title\\], service\\_context\\=service\\_context\n    )\n    \\# build summary index\n    summary\\_index \\= SummaryIndex.from\\_documents(\n        city\\_docs\\[wiki\\_title\\], service\\_context\\=service\\_context\n    )\n    \\# define query engines\n    vector\\_query\\_engine \\= vector\\_index.as\\_query\\_engine()\n    list\\_query\\_engine \\= summary\\_index.as\\_query\\_engine()\n\n    \\# define tools\n    query\\_engine\\_tools \\= \\[\n        QueryEngineTool(\n            query\\_engine\\=vector\\_query\\_engine,\n            metadata\\=ToolMetadata(\n                name\\=\"vector\\_tool\",\n                description\\=(\n                    \"Useful for summarization questions related to\"\n                    f\" {wiki\\_title}\"\n                ),\n            ),\n        ),\n        QueryEngineTool(\n            query\\_engine\\=list\\_query\\_engine,\n            metadata\\=ToolMetadata(\n                name\\=\"summary\\_tool\",\n                description\\=(\n                    f\"Useful for retrieving specific context from {wiki\\_title}\"\n                ),\n            ),\n        ),\n    \\]\n\n    \\# build agent\n    function\\_llm \\= OpenAI(model\\=\"gpt-3.5-turbo-0613\")\n    agent \\= OpenAIAgent.from\\_tools(\n        query\\_engine\\_tools,\n        llm\\=function\\_llm,\n        verbose\\=True,\n    )\n\n    agents\\[wiki\\_title\\] \\= agent\n\n## Build Recursive Retriever over these Agents[\uf0c1](#build-recursive-retriever-over-these-agents \"Permalink to this heading\")\n\nNow we define a set of summary nodes, where each node links to the corresponding Wikipedia city article. We then define a `RecursiveRetriever` on top of these Nodes to route queries down to a given node, which will in turn route it to the relevant document agent.\n\nWe finally define a full query engine combining `RecursiveRetriever` into a `RetrieverQueryEngine`.\n\n\\# define top-level nodes\nnodes \\= \\[\\]\nfor wiki\\_title in wiki\\_titles:\n    \\# define index node that links to these agents\n    wiki\\_summary \\= (\n        f\"This content contains Wikipedia articles about {wiki\\_title}. Use\"\n        \" this index if you need to lookup specific facts about\"\n        f\" {wiki\\_title}.\\\\nDo not use this index if you want to analyze\"\n        \" multiple cities.\"\n    )\n    node \\= IndexNode(text\\=wiki\\_summary, index\\_id\\=wiki\\_title)\n    nodes.append(node)\n\n\\# define top-level retriever\nvector\\_index \\= VectorStoreIndex(nodes)\nvector\\_retriever \\= vector\\_index.as\\_retriever(similarity\\_top\\_k\\=1)\n\n\\# define recursive retriever\nfrom llama\\_index.retrievers import RecursiveRetriever\nfrom llama\\_index.query\\_engine import RetrieverQueryEngine\nfrom llama\\_index.response\\_synthesizers import get\\_response\\_synthesizer\n\n\\# note: can pass \\`agents\\` dict as \\`query\\_engine\\_dict\\` since every agent can be used as a query engine\nrecursive\\_retriever \\= RecursiveRetriever(\n    \"vector\",\n    retriever\\_dict\\={\"vector\": vector\\_retriever},\n    query\\_engine\\_dict\\=agents,\n    verbose\\=True,\n)\n\n### Define Full Query Engine[\uf0c1](#define-full-query-engine \"Permalink to this heading\")\n\nThis query engine uses the recursive retriever + response synthesis module to synthesize a response.\n\nresponse\\_synthesizer \\= get\\_response\\_synthesizer(\n    \\# service\\_context=service\\_context,\n    response\\_mode\\=\"compact\",\n)\nquery\\_engine \\= RetrieverQueryEngine.from\\_args(\n    recursive\\_retriever,\n    response\\_synthesizer\\=response\\_synthesizer,\n    service\\_context\\=service\\_context,\n)\n\n## Running Example Queries[\uf0c1](#running-example-queries \"Permalink to this heading\")\n\n\\# should use Boston agent -> vector tool\nresponse \\= query\\_engine.query(\"Tell me about the sports teams in Boston\")\n\nRetrieving with query id None: Tell me about the sports teams in Boston\nRetrieved node with id, entering: Boston\nRetrieving with query id Boston: Tell me about the sports teams in Boston\n=== Calling Function ===\nCalling function: vector\\_tool with args: {\n  \"input\": \"Boston sports teams\"\n}\nGot output: Boston has teams in the four major North American men's professional sports leagues: Major League Baseball (MLB), National Football League (NFL), National Basketball Association (NBA), and National Hockey League (NHL). The city is home to the Boston Red Sox (MLB), New England Patriots (NFL), Boston Celtics (NBA), and Boston Bruins (NHL). These teams have collectively won 39 championships in their respective leagues. Additionally, Boston has a Major League Soccer (MLS) team called the New England Revolution.\n========================\nGot response: Boston is home to several professional sports teams in the major North American leagues. Here are the teams:\n\n1\\. Boston Red Sox (MLB): The Red Sox are one of the oldest and most successful baseball teams in MLB. They have won multiple World Series championships, including recent victories in 2004, 2007, 2013, and 2018.\n\n2\\. New England Patriots (NFL): The Patriots are one of the most successful teams in NFL history. Led by legendary quarterback Tom Brady, they have won six Super Bowl championships, including victories in 2001, 2003, 2004, 2014, 2016, and 2018.\n\n3\\. Boston Celtics (NBA): The Celtics are one of the most storied franchises in NBA history. They have won a record 17 NBA championships, including notable victories in the 1960s and recent success in 2008.\n\n4\\. Boston Bruins (NHL): The Bruins are a successful NHL team with a passionate fan base. They have won six Stanley Cup championships, with victories in 1929, 1939, 1941, 1970, 1972, and 2011.\n\nIn addition to these major sports teams, Boston also has a Major League Soccer (MLS) team called the New England Revolution. The Revolution play their home games at Gillette Stadium in Foxborough, Massachusetts.\n\nOverall, Boston has a rich sports culture and a history of success in various sports leagues. The city's teams have a dedicated fan base and are an integral part of the local community.\n\nBoston is home to several professional sports teams in the major North American leagues. The city has teams in MLB, NFL, NBA, and NHL. The Boston Red Sox are a successful baseball team with multiple World Series championships. The New England Patriots are a dominant NFL team with six Super Bowl championships. The Boston Celtics have a rich history in the NBA, winning a record 17 NBA championships. The Boston Bruins are a successful NHL team with six Stanley Cup championships. Additionally, Boston has a Major League Soccer team called the New England Revolution. Overall, Boston has a strong sports culture and its teams have a dedicated fan base.\n\n\\# should use Houston agent -> vector tool\nresponse \\= query\\_engine.query(\"Tell me about the sports teams in Houston\")\n\nRetrieving with query id None: Tell me about the sports teams in Houston\nRetrieved node with id, entering: Houston\nRetrieving with query id Houston: Tell me about the sports teams in Houston\nGot response: Houston is home to several professional sports teams across different leagues. Here are some of the major sports teams in Houston:\n\n1\\. Houston Texans (NFL): The Houston Texans are a professional football team and compete in the National Football League (NFL). They were established in 2002 and play their home games at NRG Stadium.\n\n2\\. Houston Rockets (NBA): The Houston Rockets are a professional basketball team and compete in the National Basketball Association (NBA). They were established in 1967 and have won two NBA championships. The Rockets play their home games at the Toyota Center.\n\n3\\. Houston Astros (MLB): The Houston Astros are a professional baseball team and compete in Major League Baseball (MLB). They were established in 1962 and have won one World Series championship. The Astros play their home games at Minute Maid Park.\n\n4\\. Houston Dynamo (MLS): The Houston Dynamo is a professional soccer team and compete in Major League Soccer (MLS). They were established in 2005 and have won two MLS Cup championships. The Dynamo play their home games at BBVA Stadium.\n\n5\\. Houston Dash (NWSL): The Houston Dash is a professional women's soccer team and compete in the National Women's Soccer League (NWSL). They were established in 2013 and have won one NWSL Challenge Cup. The Dash also play their home games at BBVA Stadium.\n\nThese are just a few of the sports teams in Houston. The city also has minor league baseball, basketball, and hockey teams, as well as college sports teams representing universities in the area.\n\nHouston is home to several professional sports teams across different leagues. Some of the major sports teams in Houston include the Houston Texans (NFL), Houston Rockets (NBA), Houston Astros (MLB), Houston Dynamo (MLS), and Houston Dash (NWSL). These teams compete in football, basketball, baseball, soccer, and women's soccer respectively. Additionally, Houston also has minor league baseball, basketball, and hockey teams, as well as college sports teams representing universities in the area.\n\n\\# should use Seattle agent -> summary tool\nresponse \\= query\\_engine.query(\n    \"Give me a summary on all the positive aspects of Chicago\"\n)\n\nRetrieving with query id None: Give me a summary on all the positive aspects of Chicago\nRetrieved node with id, entering: Chicago\nRetrieving with query id Chicago: Give me a summary on all the positive aspects of Chicago\n=== Calling Function ===\nCalling function: summary\\_tool with args: {\n  \"input\": \"positive aspects of Chicago\"\n}\nGot output: Chicago is known for its vibrant arts and culture scene, with numerous museums, theaters, and galleries that showcase a wide range of artistic expressions. The city is also home to several prestigious universities and colleges, including the University of Chicago, Northwestern University, and Illinois Institute of Technology, which consistently rank among the top \"National Universities\" in the United States. These institutions offer excellent educational opportunities for students in various fields of study. Chicago's culinary scene is also renowned, with regional specialties like deep-dish pizza, Chicago-style hot dogs, and Italian beef sandwiches. The city's diverse population has contributed to a unique food culture, with dishes like Chicken Vesuvio, the Puerto Rican-influenced jibarito, and the Maxwell Street Polish reflecting its cultural melting pot. Overall, Chicago embraces its cultural diversity through its arts, education, and culinary offerings.\n========================\nGot response: Chicago is known for its vibrant arts and culture scene, with numerous museums, theaters, and galleries that showcase a wide range of artistic expressions. The city is also home to several prestigious universities and colleges, including the University of Chicago, Northwestern University, and Illinois Institute of Technology, which consistently rank among the top \"National Universities\" in the United States. These institutions offer excellent educational opportunities for students in various fields of study. Chicago's culinary scene is also renowned, with regional specialties like deep-dish pizza, Chicago-style hot dogs, and Italian beef sandwiches. The city's diverse population has contributed to a unique food culture, with dishes like Chicken Vesuvio, the Puerto Rican-influenced jibarito, and the Maxwell Street Polish reflecting its cultural melting pot. Overall, Chicago embraces its cultural diversity through its arts, education, and culinary offerings.\n\nChicago is known for its vibrant arts and culture scene, with numerous museums, theaters, and galleries that showcase a wide range of artistic expressions. The city is also home to several prestigious universities and colleges, including the University of Chicago, Northwestern University, and Illinois Institute of Technology, which consistently rank among the top \"National Universities\" in the United States. These institutions offer excellent educational opportunities for students in various fields of study. Chicago's culinary scene is also renowned, with regional specialties like deep-dish pizza, Chicago-style hot dogs, and Italian beef sandwiches. The city's diverse population has contributed to a unique food culture, with dishes like Chicken Vesuvio, the Puerto Rican-influenced jibarito, and the Maxwell Street Polish reflecting its cultural melting pot. Overall, Chicago embraces its cultural diversity through its arts, education, and culinary offerings."
}