{
    "metadata": {
        "type": "web",
        "url": "https://docs.llamaindex.ai/en/stable/examples/composable_indices/city_analysis/City_Analysis-Unified-Query.html",
        "title": "Defining a Unified Query Interface over your Data - LlamaIndex \ud83e\udd99 0.8.49",
        "description": null
    },
    "text": "[Back to top](#)\n\nToggle table of contents sidebar\n\nThis notebook shows how to build a unified query interface that can handle:\n\n1.  **heterogeneous data sources** (e.g. data about multiple cities) and\n    \n2.  **complex queries** (e.g. compare and contrast).\n    \n\nimport logging\nimport sys\n\n\\# logging.basicConfig(stream=sys.stdout, level=logging.INFO)\n\\# logging.getLogger().addHandler(logging.StreamHandler(stream=sys.stdout))\n\n\\# Uncomment if you want to temporarily disable logger\nlogger \\= logging.getLogger()\nlogger.disabled \\= True\n\nfrom llama\\_index import (\n    VectorStoreIndex,\n    SimpleKeywordTableIndex,\n    SimpleDirectoryReader,\n    ServiceContext,\n)\n\n/Users/suo/miniconda3/envs/llama/lib/python3.9/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user\\_install.html\n  from .autonotebook import tqdm as notebook\\_tqdm\n\n## Load Datasets[\uf0c1](#load-datasets \"Permalink to this heading\")\n\nLoad Wikipedia pages about different cities.\n\nwiki\\_titles \\= \\[\"Toronto\", \"Seattle\", \"Chicago\", \"Boston\", \"Houston\"\\]\n\nfrom pathlib import Path\n\nimport requests\n\nfor title in wiki\\_titles:\n    response \\= requests.get(\n        \"https://en.wikipedia.org/w/api.php\",\n        params\\={\n            \"action\": \"query\",\n            \"format\": \"json\",\n            \"titles\": title,\n            \"prop\": \"extracts\",\n            \\# 'exintro': True,\n            \"explaintext\": True,\n        },\n    ).json()\n    page \\= next(iter(response\\[\"query\"\\]\\[\"pages\"\\].values()))\n    wiki\\_text \\= page\\[\"extract\"\\]\n\n    data\\_path \\= Path(\"data\")\n    if not data\\_path.exists():\n        Path.mkdir(data\\_path)\n\n    with open(data\\_path / f\"{title}.txt\", \"w\") as fp:\n        fp.write(wiki\\_text)\n\n\\# Load all wiki documents\ncity\\_docs \\= {}\nfor wiki\\_title in wiki\\_titles:\n    city\\_docs\\[wiki\\_title\\] \\= SimpleDirectoryReader(\n        input\\_files\\=\\[f\"data/{wiki\\_title}.txt\"\\]\n    ).load\\_data()\n\n## Building Vector Indices[\uf0c1](#building-vector-indices \"Permalink to this heading\")\n\nBuild a vector index for the wiki pages about cities.\n\nfrom llama\\_index.llms import OpenAI\n\nchatgpt \\= OpenAI(temperature\\=0, model\\=\"gpt-3.5-turbo\")\nservice\\_context \\= ServiceContext.from\\_defaults(llm\\=chatgpt, chunk\\_size\\=1024)\n\ngpt4 \\= OpenAI(temperature\\=0, model\\=\"gpt-4\")\nservice\\_context \\= ServiceContext.from\\_defaults(llm\\=gpt4, chunk\\_size\\=1024)\n\n/Users/suo/miniconda3/envs/llama/lib/python3.9/site-packages/langchain/llms/openai.py:687: UserWarning: You are trying to use a chat model. This way of initializing it is no longer supported. Instead, please use: \\`from langchain.chat\\_models import ChatOpenAI\\`\n  warnings.warn(\n\n\\# Build city document index\nvector\\_indices \\= {}\nfor wiki\\_title in wiki\\_titles:\n    \\# build vector index\n    vector\\_indices\\[wiki\\_title\\] \\= VectorStoreIndex.from\\_documents(\n        city\\_docs\\[wiki\\_title\\], service\\_context\\=service\\_context\n    )\n\n    \\# set id for vector index\n    vector\\_indices\\[wiki\\_title\\].set\\_index\\_id(wiki\\_title)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 20744 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 16942 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 26082 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 18648 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 21844 tokens\n\nindex\\_summaries \\= {\n    wiki\\_title: (\n        f\"This content contains Wikipedia articles about {wiki\\_title}. Use\"\n        \" this index if you need to lookup specific facts about\"\n        f\" {wiki\\_title}.\\\\nDo not use this index if you want to analyze\"\n        \" multiple cities.\"\n    )\n    for wiki\\_title in wiki\\_titles\n}\n\n### Test Querying the Vector Index[\uf0c1](#test-querying-the-vector-index \"Permalink to this heading\")\n\nquery\\_engine \\= vector\\_indices\\[\"Toronto\"\\].as\\_query\\_engine()\nresponse \\= query\\_engine.query(\"What are the sports teams in Toronto?\")\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 8 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 1904 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\n\nThe sports teams in Toronto include:\n\n1. Toronto Maple Leafs (NHL - ice hockey)\n2. Toronto Blue Jays (MLB - baseball)\n3. Toronto Raptors (NBA - basketball)\n4. Toronto Argonauts (CFL - Canadian football)\n5. Toronto FC (MLS - soccer)\n6. Toronto Marlies (AHL - ice hockey)\n7. Toronto Six (NWHL - women's ice hockey)\n8. Toronto Rock (NLL - lacrosse)\n9. Toronto Rush (AUDL - ultimate frisbee)\n10. Toronto Wolfpack (Rugby league, playing in the North American Rugby League tournament)\n\n## Build a Graph for Compare/Contrast Queries[\uf0c1](#build-a-graph-for-compare-contrast-queries \"Permalink to this heading\")\n\nWe build a graph by composing a keyword table index on top of all the vector indices. We use this graph for compare/contrast queries\n\nfrom llama\\_index.indices.composability import ComposableGraph\n\ngraph \\= ComposableGraph.from\\_indices(\n    SimpleKeywordTableIndex,\n    \\[index for \\_, index in vector\\_indices.items()\\],\n    \\[summary for \\_, summary in index\\_summaries.items()\\],\n    max\\_keywords\\_per\\_chunk\\=50,\n)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 0 tokens\n\n\\# get root index\nroot\\_index \\= graph.get\\_index(graph.root\\_id)\n\n\\# set id of root index\nroot\\_index.set\\_index\\_id(\"compare\\_contrast\")\n\n\\# define decompose\\_transform\nfrom llama\\_index.indices.query.query\\_transform.base import (\n    DecomposeQueryTransform,\n)\nfrom llama\\_index import LLMPredictor\n\ndecompose\\_transform \\= DecomposeQueryTransform(\n    LLMPredictor(llm\\=chatgpt), verbose\\=True\n)\n\n\\# define custom retrievers\nfrom llama\\_index.query\\_engine.transform\\_query\\_engine import (\n    TransformQueryEngine,\n)\n\ncustom\\_query\\_engines \\= {}\nfor index in vector\\_indices.values():\n    query\\_engine \\= index.as\\_query\\_engine(service\\_context\\=service\\_context)\n    query\\_engine \\= TransformQueryEngine(\n        query\\_engine,\n        query\\_transform\\=decompose\\_transform,\n        transform\\_metadata\\={\"index\\_summary\": index.index\\_struct.summary},\n    )\n    custom\\_query\\_engines\\[index.index\\_id\\] \\= query\\_engine\n\ncustom\\_query\\_engines\\[graph.root\\_id\\] \\= graph.root\\_index.as\\_query\\_engine(\n    retriever\\_mode\\=\"simple\",\n    response\\_mode\\=\"tree\\_summarize\",\n    service\\_context\\=service\\_context,\n    verbose\\=True,\n)\n\n\\# define graph\ngraph\\_query\\_engine \\= graph.as\\_query\\_engine(\n    custom\\_query\\_engines\\=custom\\_query\\_engines\n)\n\n### Test querying the graph[\uf0c1](#test-querying-the-graph \"Permalink to this heading\")\n\nquery\\_str \\= \"Compare and contrast the arts and culture of Houston and Boston. \"\nresponse \\= graph\\_query\\_engine.query(query\\_str)\n\nINFO:llama\\_index.indices.keyword\\_table.retrievers:> Starting query: Compare and contrast the arts and culture of Houston and Boston. \nINFO:llama\\_index.indices.keyword\\_table.retrievers:query keywords: \\['contrast', 'houston', 'arts', 'boston', 'culture', 'compare'\\]\nINFO:llama\\_index.indices.keyword\\_table.retrievers:> Extracted keywords: \\['houston', 'boston'\\]\n\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston. \n\\> New query: What are some notable cultural institutions or events in Houston?\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 11 tokens\n\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston. \n\\> New query: What are some notable cultural institutions or events in Houston?\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 1877 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\n\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston. \n\\> New query: What are some notable cultural institutions or events in Boston?\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 11 tokens\n\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston. \n\\> New query: What are some notable cultural institutions or events in Boston?\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 2130 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 885 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 885 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\n\nHouston and Boston both have rich arts and culture scenes, with a variety of cultural institutions and events that cater to diverse interests. Both cities have a strong presence of performing arts organizations, such as the Houston Grand Opera and Houston Ballet in Houston, and the Boston Ballet and Boston Lyric Opera Company in Boston. They also have renowned symphony orchestras, with the Houston Symphony Orchestra and the Boston Symphony Orchestra.\n\nBoth cities host annual events that celebrate their unique cultural identities, such as the Houston Livestock Show and Rodeo, Houston Gay Pride Parade, and Houston Greek Festival in Houston, and the Boston Gay Pride Parade and Festival, Italian Summer Feasts, and Fourth of July events in Boston. Additionally, both cities have thriving theater districts, with Houston's Theater District and Boston's Theater District housing several historic and modern theaters.\n\nIn terms of visual arts, both Houston and Boston have notable art museums, such as the Museum of Fine Arts in both cities, as well as the Houston Museum of Natural Science and the Contemporary Arts Museum Houston in Houston, and the Isabella Stewart Gardner Museum and the Institute of Contemporary Art in Boston. Houston also has unique institutions like the Menil Collection, Rothko Chapel, and the Byzantine Fresco Chapel Museum, while Boston has historic sites related to the American Revolution preserved in the Boston National Historical Park and along the Freedom Trail.\n\nWhile both cities have a strong focus on arts and culture, Houston's cultural scene tends to be more diverse, with events like the Art Car Parade, Houston International Festival, and Bayou City Art Festival showcasing the city's eclectic mix of cultures. On the other hand, Boston's cultural scene is deeply rooted in its history and traditions, with events like the Boston Early Music Festival and historic sites along the Freedom Trail reflecting the city's rich past.\n\n## Build a router to automatically choose between indices and graph[\uf0c1](#build-a-router-to-automatically-choose-between-indices-and-graph \"Permalink to this heading\")\n\nWe can use a `RouterQueryEngine` to automatically route to the vector indices and the graph.\n\nTo do this, first build the query engines, and give each a description to obtain a `QueryEngineTool`.\n\nfrom llama\\_index.tools.query\\_engine import QueryEngineTool\n\nquery\\_engine\\_tools \\= \\[\\]\n\n\\# add vector index tools\nfor wiki\\_title in wiki\\_titles:\n    index \\= vector\\_indices\\[wiki\\_title\\]\n    summary \\= index\\_summaries\\[wiki\\_title\\]\n\n    query\\_engine \\= index.as\\_query\\_engine(service\\_context\\=service\\_context)\n    vector\\_tool \\= QueryEngineTool.from\\_defaults(\n        query\\_engine, description\\=summary\n    )\n    query\\_engine\\_tools.append(vector\\_tool)\n\n\\# add graph tool\ngraph\\_description \\= (\n    \"This tool contains Wikipedia articles about multiple cities. \"\n    \"Use this tool if you want to compare multiple cities. \"\n)\ngraph\\_tool \\= QueryEngineTool.from\\_defaults(\n    graph\\_query\\_engine, description\\=graph\\_description\n)\nquery\\_engine\\_tools.append(graph\\_tool)\n\nThen, define the `RouterQueryEngine` with a desired selector module. Here, we use the `LLMSingleSelector`, which uses LLM to choose a underlying query engine to route the query to.\n\nfrom llama\\_index.query\\_engine.router\\_query\\_engine import RouterQueryEngine\nfrom llama\\_index.selectors.llm\\_selectors import LLMSingleSelector\n\nrouter\\_query\\_engine \\= RouterQueryEngine(\n    selector\\=LLMSingleSelector.from\\_defaults(service\\_context\\=service\\_context),\n    query\\_engine\\_tools\\=query\\_engine\\_tools,\n)\n\nAsking a compare and contrast question should route the query to the graph.\n\n\\# ask a compare/contrast question\nresponse \\= router\\_query\\_engine.query(\n    \"Compare and contrast the arts and culture of Houston and Boston.\",\n)\n\nINFO:llama\\_index.query\\_engine.router\\_query\\_engine:Selecting query engine 5: This tool contains Wikipedia articles about multiple cities, which allows for comparison and analysis of different cities, such as Houston and Boston..\nINFO:llama\\_index.indices.keyword\\_table.retrievers:> Starting query: Compare and contrast the arts and culture of Houston and Boston.\nINFO:llama\\_index.indices.keyword\\_table.retrievers:query keywords: \\['contrast', 'houston', 'arts', 'boston', 'culture', 'compare'\\]\nINFO:llama\\_index.indices.keyword\\_table.retrievers:> Extracted keywords: \\['houston', 'boston'\\]\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 11 tokens\n\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston.\n\\> New query: What are some notable cultural institutions or events in Houston?\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston.\n\\> New query: What are some notable cultural institutions or events in Houston and Boston?\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 1835 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\n\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston.\n\\> New query: What are some notable cultural institutions or events in Boston?\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 11 tokens\n\n\\> Current query: Compare and contrast the arts and culture of Houston and Boston.\n\\> New query: What are some notable cultural institutions or events in Boston?\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 2134 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 772 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 772 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\n\nBased on the context information provided, both Houston and Boston have rich arts and cultural scenes, with a variety of institutions and events catering to diverse interests.\n\nHouston's cultural institutions and events include the Houston Theater District, the Museum District, the Houston Livestock Show and Rodeo, the Houston Gay Pride Parade, the Houston Greek Festival, the Art Car Parade, the Houston Auto Show, the Houston International Festival, and the Bayou City Art Festival.\n\nIn contrast, Boston's cultural institutions and events include the Boston Symphony Hall, New England Conservatory's Jordan Hall, Boston Ballet, various performing-arts organizations, contemporary classical music groups, the Theater District, First Night, Boston Early Music Festival, Boston Arts Festival, Boston Gay Pride Parade and Festival, Italian Summer Feasts, Fourth of July events, art museums such as the Museum of Fine Arts and Isabella Stewart Gardner Museum, the Institute of Contemporary Art, art gallery destinations like the South End Art and Design District (SoWa) and Newbury St, and the Boston National Historical Park.\n\nBoth cities have theater districts, gay pride parades, and arts festivals. However, Houston has unique events such as the Livestock Show and Rodeo, the Greek Festival, the Art Car Parade, and the Houston Auto Show. On the other hand, Boston has a strong focus on classical music with venues like the Symphony Hall and Jordan Hall, as well as historical sites related to the American Revolution.\n\nAsking a question about a specific city should route the query to the specific vector index query engine.\n\nresponse \\= router\\_query\\_engine.query(\"What are the sports teams in Toronto?\")\n\nINFO:llama\\_index.query\\_engine.router\\_query\\_engine:Selecting query engine 0: This content contains Wikipedia articles about Toronto, which can provide information about the sports teams in the city..\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 8 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total LLM token usage: 1905 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[get\\_response\\] Total embedding token usage: 0 tokens\n\nThe sports teams in Toronto include:\n\n1. Toronto Maple Leafs (NHL - ice hockey)\n2. Toronto Blue Jays (MLB - baseball)\n3. Toronto Raptors (NBA - basketball)\n4. Toronto Argonauts (CFL - Canadian football)\n5. Toronto FC (MLS - soccer)\n6. Toronto Marlies (AHL - ice hockey)\n7. Toronto Six (NWHL - women's ice hockey)\n8. Toronto Rock (NLL - lacrosse)\n9. Toronto Rush (AUDL - ultimate frisbee)\n10. Toronto Wolfpack (Rugby league, currently playing in the North American Rugby League tournament)"
}