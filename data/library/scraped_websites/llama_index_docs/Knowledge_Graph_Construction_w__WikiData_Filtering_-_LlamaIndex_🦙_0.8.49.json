{
    "metadata": {
        "type": "web",
        "url": "https://docs.llamaindex.ai/en/stable/examples/index_structs/knowledge_graph/knowledge_graph2.html",
        "title": "Knowledge Graph Construction w/ WikiData Filtering - LlamaIndex \ud83e\udd99 0.8.49",
        "description": null
    },
    "text": "[Back to top](#)\n\nToggle table of contents sidebar\n\nIn this notebook, we compare using [REBEL](https://huggingface.co/Babelscape/rebel-large) for knowledge graph construction with and without filtering from wikidata.\n\nThis is a simplified version, find out more about using wikipedia for filtering, check here\n\n*   [Make Meaningful Knowledge Graph from OpenSource REBEL Model](https://medium.com/@haiyangli_38602/make-meaningful-knowledge-graph-from-opensource-rebel-model-6f9729a55527)\n    \n\n## Setup[\uf0c1](#setup \"Permalink to this heading\")\n\n!pip install llama\\_index transformers wikipedia html2text pyvis\n\nRequirement already satisfied: llama\\_index in /usr/local/lib/python3.10/dist-packages (0.8.37)\nRequirement already satisfied: transformers in /usr/local/lib/python3.10/dist-packages (4.33.3)\nRequirement already satisfied: wikipedia in /usr/local/lib/python3.10/dist-packages (1.4.0)\nRequirement already satisfied: html2text in /usr/local/lib/python3.10/dist-packages (2020.1.16)\nRequirement already satisfied: pyvis in /usr/local/lib/python3.10/dist-packages (0.3.2)\nRequirement already satisfied: tiktoken in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (0.5.1)\nRequirement already satisfied: dataclasses-json in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (0.6.1)\nRequirement already satisfied: langchain>=0.0.303 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (0.0.305)\nRequirement already satisfied: sqlalchemy>=2.0.15 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (2.0.20)\nRequirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (1.23.5)\nRequirement already satisfied: tenacity<9.0.0,>=8.2.0 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (8.2.3)\nRequirement already satisfied: openai>=0.26.4 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (0.28.1)\nRequirement already satisfied: pandas in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (1.5.3)\nRequirement already satisfied: urllib3<2 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (1.26.16)\nRequirement already satisfied: fsspec>=2023.5.0 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (2023.6.0)\nRequirement already satisfied: typing-inspect>=0.8.0 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (0.9.0)\nRequirement already satisfied: typing-extensions>=4.5.0 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (4.5.0)\nRequirement already satisfied: beautifulsoup4 in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (4.11.2)\nRequirement already satisfied: nest-asyncio in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (1.5.7)\nRequirement already satisfied: nltk in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (3.8.1)\nRequirement already satisfied: tree-sitter-languages in /usr/local/lib/python3.10/dist-packages (from llama\\_index) (1.7.0)\nRequirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from transformers) (3.12.2)\nRequirement already satisfied: huggingface-hub<1.0,>=0.15.1 in /usr/local/lib/python3.10/dist-packages (from transformers) (0.17.3)\nRequirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.10/dist-packages (from transformers) (23.1)\nRequirement already satisfied: pyyaml>=5.1 in /usr/local/lib/python3.10/dist-packages (from transformers) (6.0.1)\nRequirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.10/dist-packages (from transformers) (2023.6.3)\nRequirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from transformers) (2.31.0)\nRequirement already satisfied: tokenizers!=0.11.3,<0.14,>=0.11.1 in /usr/local/lib/python3.10/dist-packages (from transformers) (0.13.3)\nRequirement already satisfied: safetensors>=0.3.1 in /usr/local/lib/python3.10/dist-packages (from transformers) (0.3.3)\nRequirement already satisfied: tqdm>=4.27 in /usr/local/lib/python3.10/dist-packages (from transformers) (4.66.1)\nRequirement already satisfied: ipython>=5.3.0 in /usr/local/lib/python3.10/dist-packages (from pyvis) (7.34.0)\nRequirement already satisfied: jinja2>=2.9.6 in /usr/local/lib/python3.10/dist-packages (from pyvis) (3.1.2)\nRequirement already satisfied: jsonpickle>=1.4.1 in /usr/local/lib/python3.10/dist-packages (from pyvis) (3.0.2)\nRequirement already satisfied: networkx>=1.11 in /usr/local/lib/python3.10/dist-packages (from pyvis) (3.1)\nRequirement already satisfied: setuptools>=18.5 in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (67.7.2)\nRequirement already satisfied: jedi>=0.16 in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (0.19.0)\nRequirement already satisfied: decorator in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (4.4.2)\nRequirement already satisfied: pickleshare in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (0.7.5)\nRequirement already satisfied: traitlets>=4.2 in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (5.7.1)\nRequirement already satisfied: prompt-toolkit!=3.0.0,!=3.0.1,<3.1.0,>=2.0.0 in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (3.0.39)\nRequirement already satisfied: pygments in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (2.16.1)\nRequirement already satisfied: backcall in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (0.2.0)\nRequirement already satisfied: matplotlib-inline in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (0.1.6)\nRequirement already satisfied: pexpect>4.3 in /usr/local/lib/python3.10/dist-packages (from ipython>=5.3.0->pyvis) (4.8.0)\nRequirement already satisfied: MarkupSafe>=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2>=2.9.6->pyvis) (2.1.3)\nRequirement already satisfied: aiohttp<4.0.0,>=3.8.3 in /usr/local/lib/python3.10/dist-packages (from langchain>=0.0.303->llama\\_index) (3.8.5)\nRequirement already satisfied: anyio<4.0 in /usr/local/lib/python3.10/dist-packages (from langchain>=0.0.303->llama\\_index) (3.7.1)\nRequirement already satisfied: async-timeout<5.0.0,>=4.0.0 in /usr/local/lib/python3.10/dist-packages (from langchain>=0.0.303->llama\\_index) (4.0.3)\nRequirement already satisfied: jsonpatch<2.0,>=1.33 in /usr/local/lib/python3.10/dist-packages (from langchain>=0.0.303->llama\\_index) (1.33)\nRequirement already satisfied: langsmith<0.1.0,>=0.0.38 in /usr/local/lib/python3.10/dist-packages (from langchain>=0.0.303->llama\\_index) (0.0.41)\nRequirement already satisfied: numexpr<3.0.0,>=2.8.4 in /usr/local/lib/python3.10/dist-packages (from langchain>=0.0.303->llama\\_index) (2.8.5)\nRequirement already satisfied: pydantic<3,>=1 in /usr/local/lib/python3.10/dist-packages (from langchain>=0.0.303->llama\\_index) (1.10.12)\nRequirement already satisfied: marshmallow<4.0.0,>=3.18.0 in /usr/local/lib/python3.10/dist-packages (from dataclasses-json->llama\\_index) (3.20.1)\nRequirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->transformers) (3.2.0)\nRequirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->transformers) (3.4)\nRequirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->transformers) (2023.7.22)\nRequirement already satisfied: greenlet!=0.4.17 in /usr/local/lib/python3.10/dist-packages (from sqlalchemy>=2.0.15->llama\\_index) (2.0.2)\nRequirement already satisfied: mypy-extensions>=0.3.0 in /usr/local/lib/python3.10/dist-packages (from typing-inspect>=0.8.0->llama\\_index) (1.0.0)\nRequirement already satisfied: soupsieve>1.2 in /usr/local/lib/python3.10/dist-packages (from beautifulsoup4->llama\\_index) (2.5)\nRequirement already satisfied: click in /usr/local/lib/python3.10/dist-packages (from nltk->llama\\_index) (8.1.7)\nRequirement already satisfied: joblib in /usr/local/lib/python3.10/dist-packages (from nltk->llama\\_index) (1.3.2)\nRequirement already satisfied: python-dateutil>=2.8.1 in /usr/local/lib/python3.10/dist-packages (from pandas->llama\\_index) (2.8.2)\nRequirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.10/dist-packages (from pandas->llama\\_index) (2023.3.post1)\nRequirement already satisfied: tree-sitter in /usr/local/lib/python3.10/dist-packages (from tree-sitter-languages->llama\\_index) (0.20.2)\nRequirement already satisfied: attrs>=17.3.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain>=0.0.303->llama\\_index) (23.1.0)\nRequirement already satisfied: multidict<7.0,>=4.5 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain>=0.0.303->llama\\_index) (6.0.4)\nRequirement already satisfied: yarl<2.0,>=1.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain>=0.0.303->llama\\_index) (1.9.2)\nRequirement already satisfied: frozenlist>=1.1.1 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain>=0.0.303->llama\\_index) (1.4.0)\nRequirement already satisfied: aiosignal>=1.1.2 in /usr/local/lib/python3.10/dist-packages (from aiohttp<4.0.0,>=3.8.3->langchain>=0.0.303->llama\\_index) (1.3.1)\nRequirement already satisfied: sniffio>=1.1 in /usr/local/lib/python3.10/dist-packages (from anyio<4.0->langchain>=0.0.303->llama\\_index) (1.3.0)\nRequirement already satisfied: exceptiongroup in /usr/local/lib/python3.10/dist-packages (from anyio<4.0->langchain>=0.0.303->llama\\_index) (1.1.3)\nRequirement already satisfied: parso<0.9.0,>=0.8.3 in /usr/local/lib/python3.10/dist-packages (from jedi>=0.16->ipython>=5.3.0->pyvis) (0.8.3)\nRequirement already satisfied: jsonpointer>=1.9 in /usr/local/lib/python3.10/dist-packages (from jsonpatch<2.0,>=1.33->langchain>=0.0.303->llama\\_index) (2.4)\nRequirement already satisfied: ptyprocess>=0.5 in /usr/local/lib/python3.10/dist-packages (from pexpect>4.3->ipython>=5.3.0->pyvis) (0.7.0)\nRequirement already satisfied: wcwidth in /usr/local/lib/python3.10/dist-packages (from prompt-toolkit!=3.0.0,!=3.0.1,<3.1.0,>=2.0.0->ipython>=5.3.0->pyvis) (0.2.6)\nRequirement already satisfied: six>=1.5 in /usr/local/lib/python3.10/dist-packages (from python-dateutil>=2.8.1->pandas->llama\\_index) (1.16.0)\n\nimport logging\nimport sys\n\nlogging.basicConfig(stream\\=sys.stdout, level\\=logging.INFO)\nlogging.getLogger().addHandler(logging.StreamHandler(stream\\=sys.stdout))\n\nfrom llama\\_index import (\n    ServiceContext,\n    KnowledgeGraphIndex,\n)\nfrom llama\\_index import SimpleWebPageReader\nfrom llama\\_index.graph\\_stores import SimpleGraphStore\nfrom llama\\_index.storage.storage\\_context import StorageContext\nfrom llama\\_index.llms import OpenAI\n\n## Run with Llama\\_Index[\uf0c1](#run-with-llama-index \"Permalink to this heading\")\n\nfrom llama\\_index import download\\_loader\n\nArxivReader \\= download\\_loader(\"ArxivReader\")\n\nloader \\= ArxivReader()\ndocuments \\= loader.load\\_data(\n    search\\_query\\=\"Retrieval Augmented Generation\", max\\_results\\=1\n)\n\nimport os\nimport openai\n\nos.environ\\[\"OPENAI\\_API\\_KEY\"\\] \\= \"sk-...\"\nopenai.api\\_key \\= os.environ\\[\"OPENAI\\_API\\_KEY\"\\]\n\nfrom llama\\_index import Document\n\n\\# merge all documents into one, since it's split by page\ndocuments \\= \\[Document(text\\=\"\".join(\\[x.text for x in documents\\]))\\]\n\n\\# set up service context\nllm \\= OpenAI(temperature\\=0.1, model\\=\"gpt-3.5-turbo\")\nservice\\_context \\= ServiceContext.from\\_defaults(llm\\=llm, chunk\\_size\\=256)\n\n\\# set up graph storage context\ngraph\\_store \\= SimpleGraphStore()\nstorage\\_context \\= StorageContext.from\\_defaults(graph\\_store\\=graph\\_store)\n\n\\[nltk\\_data\\] Downloading package punkt to /tmp/llama\\_index...\n\\[nltk\\_data\\]   Unzipping tokenizers/punkt.zip.\n\nNOTE: This next cell takes about 4mins on GPU.\n\nindex \\= KnowledgeGraphIndex.from\\_documents(\n    documents,\n    max\\_triplets\\_per\\_chunk\\=3,\n    kg\\_triplet\\_extract\\_fn\\=extract\\_triplets,\n    storage\\_context\\=storage\\_context,\n    service\\_context\\=service\\_context,\n    include\\_embeddings\\=True,\n)\n\nindex1 \\= KnowledgeGraphIndex.from\\_documents(\n    documents,\n    max\\_triplets\\_per\\_chunk\\=3,\n    kg\\_triplet\\_extract\\_fn\\=extract\\_triplets\\_wiki,\n    storage\\_context\\=storage\\_context,\n    service\\_context\\=service\\_context,\n    include\\_embeddings\\=True,\n)\n\n/usr/local/lib/python3.10/dist-packages/transformers/pipelines/base.py:1101: UserWarning: You seem to be using the pipelines sequentially on GPU. In order to maximize efficiency please use a dataset\n  warnings.warn(\n/usr/local/lib/python3.10/dist-packages/wikipedia/wikipedia.py:389: GuessedAtParserWarning: No parser was explicitly specified, so I'm using the best available HTML parser for this system (\"lxml\"). This usually isn't a problem, but if you run this code on another system, or in a different virtual environment, it may use a different parser and behave differently.\n\nThe code that caused this warning is on line 389 of the file /usr/local/lib/python3.10/dist-packages/wikipedia/wikipedia.py. To get rid of this warning, pass the additional argument 'features=\"lxml\"' to the BeautifulSoup constructor.\n\n  lis = BeautifulSoup(html).find\\_all('li')\n\n\\## create graph\nfrom pyvis.network import Network\n\ng \\= index.get\\_networkx\\_graph()\nnet \\= Network(notebook\\=True, cdn\\_resources\\=\"in\\_line\", directed\\=True)\nnet.from\\_nx(g)\nnet.save\\_graph(\"non\\_filtered\\_graph.html\")\n\nfrom IPython.display import HTML\n\nHTML(filename\\=\"non\\_filtered\\_graph.html\")\n\n\\## create graph\nfrom pyvis.network import Network\n\ng \\= index1.get\\_networkx\\_graph()\nnet \\= Network(notebook\\=True, cdn\\_resources\\=\"in\\_line\", directed\\=True)\nnet.from\\_nx(g)\nnet.save\\_graph(\"wiki\\_filtered\\_graph.html\")\n\nfrom IPython.display import HTML\n\nHTML(filename\\=\"wiki\\_filtered\\_graph.html\")"
}