{
    "metadata": {
        "type": "web",
        "url": "https://docs.llamaindex.ai/en/stable/examples/node_postprocessor/LLMReranker-Gatsby.html",
        "title": "LLM Reranker Demonstration (Great Gatsby) - LlamaIndex \ud83e\udd99 0.8.49",
        "description": null
    },
    "text": "This tutorial showcases how to do a two-stage pass for retrieval. Use embedding-based retrieval with a high top-k value in order to maximize recall and get a large set of candidate items. Then, use LLM-based retrieval to dynamically select the nodes that are actually relevant to the query.\n\n## Retrieval[\uf0c1](#retrieval \"Permalink to this heading\")\n\nfrom llama\\_index.retrievers import VectorIndexRetriever\nfrom llama\\_index.indices.query.schema import QueryBundle\nimport pandas as pd\nfrom IPython.display import display, HTML\n\npd.set\\_option(\"display.max\\_colwidth\", \\-1)\n\ndef get\\_retrieved\\_nodes(\n    query\\_str, vector\\_top\\_k\\=10, reranker\\_top\\_n\\=3, with\\_reranker\\=False\n):\n    query\\_bundle \\= QueryBundle(query\\_str)\n    \\# configure retriever\n    retriever \\= VectorIndexRetriever(\n        index\\=index,\n        similarity\\_top\\_k\\=vector\\_top\\_k,\n    )\n    retrieved\\_nodes \\= retriever.retrieve(query\\_bundle)\n\n    if with\\_reranker:\n        \\# configure reranker\n        reranker \\= LLMRerank(\n            choice\\_batch\\_size\\=5,\n            top\\_n\\=reranker\\_top\\_n,\n            service\\_context\\=service\\_context,\n        )\n        retrieved\\_nodes \\= reranker.postprocess\\_nodes(\n            retrieved\\_nodes, query\\_bundle\n        )\n\n    return retrieved\\_nodes\n\ndef pretty\\_print(df):\n    return display(HTML(df.to\\_html().replace(\"\\\\\\\\n\", \"<br>\")))\n\ndef visualize\\_retrieved\\_nodes(nodes) \\-> None:\n    result\\_dicts \\= \\[\\]\n    for node in nodes:\n        result\\_dict \\= {\"Score\": node.score, \"Text\": node.node.get\\_text()}\n        result\\_dicts.append(result\\_dict)\n\n    pretty\\_print(pd.DataFrame(result\\_dicts))\n\n/var/folders/1r/c3h91d9s49xblwfvz79s78\\_c0000gn/T/ipykernel\\_44297/3519340226.py:7: FutureWarning: Passing a negative integer is deprecated in version 1.0 and will not be supported in future version. Instead, use None to not limit the column width.\n  pd.set\\_option('display.max\\_colwidth', -1)\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"Who was driving the car that hit Myrtle?\",\n    vector\\_top\\_k\\=3,\n    with\\_reranker\\=False,\n)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 10 tokens\n> \\[retrieve\\] Total embedding token usage: 10 tokens\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n|     | Score | Text |\n| --- | --- | --- |\n| 0   | 0.828844 | and some garrulous man telling over and over what  <br>had happened, until it became less and less real even to him and he  <br>could tell it no longer, and Myrtle Wilson\u2019s tragic achievement was  <br>forgotten. Now I want to go back a little and tell what happened at  <br>the garage after we left there the night before.<br><br>They had difficulty in locating the sister, Catherine. She must have  <br>broken her rule against drinking that night, for when she arrived she  <br>was stupid with liquor and unable to understand that the ambulance had  <br>already gone to Flushing. When they convinced her of this, she  <br>immediately fainted, as if that was the intolerable part of the  <br>affair. Someone, kind or curious, took her in his car and drove her in  <br>the wake of her sister\u2019s body.<br><br>Until long after midnight a changing crowd lapped up against the front  <br>of the garage, while George Wilson rocked himself back and forth on  <br>the couch inside. For a while the door of the office was open, and  <br>everyone who came into the garage glanced irresistibly through it.  <br>Finally someone said it was a shame, and closed the door. Michaelis  <br>and several other men were with him; first, four or five men, later  <br>two or three men. Still later Michaelis had to ask the last stranger  <br>to wait there fifteen minutes longer, while he went back to his own  <br>place and made a pot of coffee. After that, he stayed there alone with  <br>Wilson until dawn.<br><br>About three o\u2019clock the quality of Wilson\u2019s incoherent muttering  <br>changed\u2014he grew quieter and began to talk about the yellow car. He  <br>announced that he had a way of finding out whom the yellow car  <br>belonged to, and then he blurted out that a couple of months ago his  <br>wife had come from the city with her face bruised and her nose  <br>swollen.<br><br>But when he heard himself say this, he flinched and began to cry \u201cOh,  <br>my God!\u201d again in his groaning voice. Michaelis made a clumsy |\n| 1   | 0.827754 | she rushed out into the dusk, waving her hands and  <br>shouting\u2014before he could move from his door the business was over.<br><br>The \u201cdeath car\u201d as the newspapers called it, didn\u2019t stop; it came out  <br>of the gathering darkness, wavered tragically for a moment, and then  <br>disappeared around the next bend. Mavro Michaelis wasn\u2019t even sure of  <br>its colour\u2014he told the first policeman that it was light green. The  <br>other car, the one going toward New York, came to rest a hundred yards  <br>beyond, and its driver hurried back to where Myrtle Wilson, her life  <br>violently extinguished, knelt in the road and mingled her thick dark  <br>blood with the dust.<br><br>Michaelis and this man reached her first, but when they had torn open  <br>her shirtwaist, still damp with perspiration, they saw that her left  <br>breast was swinging loose like a flap, and there was no need to listen  <br>for the heart beneath. The mouth was wide open and ripped a little at  <br>the corners, as though she had choked a little in giving up the  <br>tremendous vitality she had stored so long.<br><br>\\------------------------------------------------------------------------<br><br>We saw the three or four automobiles and the crowd when we were still  <br>some distance away.<br><br>\u201cWreck!\u201d said Tom. \u201cThat\u2019s good. Wilson\u2019ll have a little business at  <br>last.\u201d<br><br>He slowed down, but still without any intention of stopping, until, as  <br>we came nearer, the hushed, intent faces of the people at the garage  <br>door made him automatically put on the brakes.<br><br>\u201cWe\u2019ll take a look,\u201d he said doubtfully, \u201cjust a look.\u201d<br><br>I became aware now of a hollow, wailing sound which issued incessantly  <br>from the garage, a sound which as we got out of the coup\u00e9 and walked  <br>toward the door resolved itself into the words \u201cOh, my God!\u201d uttered  <br>over and over in a gasping |\n| 2   | 0.826390 | went on, \u201cand left the car in  <br>my garage. I don\u2019t think anybody saw us, but of course I can\u2019t be  <br>sure.\u201d<br><br>I disliked him so much by this time that I didn\u2019t find it necessary to  <br>tell him he was wrong.<br><br>\u201cWho was the woman?\u201d he inquired.<br><br>\u201cHer name was Wilson. Her husband owns the garage. How the devil did  <br>it happen?\u201d<br><br>\u201cWell, I tried to swing the wheel\u2014\u201d He broke off, and suddenly I  <br>guessed at the truth.<br><br>\u201cWas Daisy driving?\u201d<br><br>\u201cYes,\u201d he said after a moment, \u201cbut of course I\u2019ll say I was. You see,  <br>when we left New York she was very nervous and she thought it would  <br>steady her to drive\u2014and this woman rushed out at us just as we were  <br>passing a car coming the other way. It all happened in a minute, but  <br>it seemed to me that she wanted to speak to us, thought we were  <br>somebody she knew. Well, first Daisy turned away from the woman toward  <br>the other car, and then she lost her nerve and turned back. The second  <br>my hand reached the wheel I felt the shock\u2014it must have killed her  <br>instantly.\u201d<br><br>\u201cIt ripped her open\u2014\u201d<br><br>\u201cDon\u2019t tell me, old sport.\u201d He winced. \u201cAnyhow\u2014Daisy stepped on it. I  <br>tried to make her stop, but she couldn\u2019t, so I pulled on the emergency  <br>brake. Then she fell over into my lap and I drove on.<br><br>\u201cShe\u2019ll be all right tomorrow,\u201d he said presently. \u201cI\u2019m just going to  <br>wait here and see if he tries to bother her about that unpleasantness  <br>this afternoon. She\u2019s locked herself into her room, and if he tries  <br>any brutality she\u2019s going to turn the light out and on again.\u201d<br><br>\u201cHe won\u2019t touch |\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"Who was driving the car that hit Myrtle?\",\n    vector\\_top\\_k\\=10,\n    reranker\\_top\\_n\\=3,\n    with\\_reranker\\=True,\n)\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n|     | Score | Text |\n| --- | --- | --- |\n| 0   | 10.0 | went on, \u201cand left the car in  <br>my garage. I don\u2019t think anybody saw us, but of course I can\u2019t be  <br>sure.\u201d<br><br>I disliked him so much by this time that I didn\u2019t find it necessary to  <br>tell him he was wrong.<br><br>\u201cWho was the woman?\u201d he inquired.<br><br>\u201cHer name was Wilson. Her husband owns the garage. How the devil did  <br>it happen?\u201d<br><br>\u201cWell, I tried to swing the wheel\u2014\u201d He broke off, and suddenly I  <br>guessed at the truth.<br><br>\u201cWas Daisy driving?\u201d<br><br>\u201cYes,\u201d he said after a moment, \u201cbut of course I\u2019ll say I was. You see,  <br>when we left New York she was very nervous and she thought it would  <br>steady her to drive\u2014and this woman rushed out at us just as we were  <br>passing a car coming the other way. It all happened in a minute, but  <br>it seemed to me that she wanted to speak to us, thought we were  <br>somebody she knew. Well, first Daisy turned away from the woman toward  <br>the other car, and then she lost her nerve and turned back. The second  <br>my hand reached the wheel I felt the shock\u2014it must have killed her  <br>instantly.\u201d<br><br>\u201cIt ripped her open\u2014\u201d<br><br>\u201cDon\u2019t tell me, old sport.\u201d He winced. \u201cAnyhow\u2014Daisy stepped on it. I  <br>tried to make her stop, but she couldn\u2019t, so I pulled on the emergency  <br>brake. Then she fell over into my lap and I drove on.<br><br>\u201cShe\u2019ll be all right tomorrow,\u201d he said presently. \u201cI\u2019m just going to  <br>wait here and see if he tries to bother her about that unpleasantness  <br>this afternoon. She\u2019s locked herself into her room, and if he tries  <br>any brutality she\u2019s going to turn the light out and on again.\u201d<br><br>\u201cHe won\u2019t touch |\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"What did Gatsby want Daisy to do in front of Tom?\",\n    vector\\_top\\_k\\=3,\n    with\\_reranker\\=False,\n)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 14 tokens\n> \\[retrieve\\] Total embedding token usage: 14 tokens\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n\\*\\*\\*\\*Score\\*\\*\\*\\*: 0.8647796939111776\n\\*\\*\\*\\*Node text\\*\\*\\*\\*\n: got to make your house into a pigsty in order to have any\nfriends\u2014in the modern world.\u201d\n\nAngry as I was, as we all were, I was tempted to laugh whenever he\nopened his mouth. The transition from libertine to prig was so\ncomplete.\n\n\u201cI\u2019ve got something to tell you, old sport\u2014\u201d began Gatsby. But Daisy\nguessed at his intention.\n\n\u201cPlease don\u2019t!\u201d she interrupted helplessly. \u201cPlease let\u2019s all go\nhome. Why don\u2019t we all go home?\u201d\n\n\u201cThat\u2019s a good idea,\u201d I got up. \u201cCome on, Tom. Nobody wants a drink.\u201d\n\n\u201cI want to know what Mr. Gatsby has to tell me.\u201d\n\n\u201cYour wife doesn\u2019t love you,\u201d said Gatsby. \u201cShe\u2019s never loved you.\nShe loves me.\u201d\n\n\u201cYou must be crazy!\u201d exclaimed Tom automatically.\n\nGatsby sprang to his feet, vivid with excitement.\n\n\u201cShe never loved you, do you hear?\u201d he cried. \u201cShe only married you\nbecause I was poor and she was tired of waiting for me. It was a\nterrible mistake, but in her heart she never loved anyone except me!\u201d\n\nAt this point Jordan and I tried to go, but Tom and Gatsby insisted\nwith competitive firmness that we remain\u2014as though neither of them had\nanything to conceal and it would be a privilege to partake vicariously\nof their emotions.\n\n\u201cSit down, Daisy,\u201d Tom\u2019s voice groped unsuccessfully for the paternal\nnote. \u201cWhat\u2019s been going on? I want to hear all about it.\u201d\n\n\u201cI told you what\u2019s been going on,\u201d said Gatsby. \u201cGoing on for five\nyears\u2014and you didn\u2019t know.\u201d\n\nTom turned to Daisy\n\n\n\\*\\*\\*\\*Score\\*\\*\\*\\*: 0.8609230717744326\n\\*\\*\\*\\*Node text\\*\\*\\*\\*\n: to keep your\nshoes dry?\u201d There was a husky tenderness in his tone \u2026 \u201cDaisy?\u201d\n\n\u201cPlease don\u2019t.\u201d Her voice was cold, but the rancour was gone from it.\nShe looked at Gatsby. \u201cThere, Jay,\u201d she said\u2014but her hand as she tried\nto light a cigarette was trembling. Suddenly she threw the cigarette\nand the burning match on the carpet.\n\n\u201cOh, you want too much!\u201d she cried to Gatsby. \u201cI love you now\u2014isn\u2019t\nthat enough? I can\u2019t help what\u2019s past.\u201d She began to sob\nhelplessly. \u201cI did love him once\u2014but I loved you too.\u201d\n\nGatsby\u2019s eyes opened and closed.\n\n\u201cYou loved me too?\u201d he repeated.\n\n\u201cEven that\u2019s a lie,\u201d said Tom savagely. \u201cShe didn\u2019t know you were\nalive. Why\u2014there\u2019s things between Daisy and me that you\u2019ll never know,\nthings that neither of us can ever forget.\u201d\n\nThe words seemed to bite physically into Gatsby.\n\n\u201cI want to speak to Daisy alone,\u201d he insisted. \u201cShe\u2019s all excited\nnow\u2014\u201d\n\n\u201cEven alone I can\u2019t say I never loved Tom,\u201d she admitted in a pitiful\nvoice. \u201cIt wouldn\u2019t be true.\u201d\n\n\u201cOf course it wouldn\u2019t,\u201d agreed Tom.\n\nShe turned to her husband.\n\n\u201cAs if it mattered to you,\u201d she said.\n\n\u201cOf course it matters. I\u2019m going to take better care of you from now\non.\u201d\n\n\u201cYou don\u2019t understand,\u201d said Gatsby, with a touch of panic. \u201cYou\u2019re\nnot going to take care of her any more.\u201d\n\n\u201cI\u2019m not?\u201d Tom opened his eyes wide and\n\n\n\\*\\*\\*\\*Score\\*\\*\\*\\*: 0.8555028907426916\n\\*\\*\\*\\*Node text\\*\\*\\*\\*\n: shadowed well with awnings, was dark and cool. Daisy and\nJordan lay upon an enormous couch, like silver idols weighing down\ntheir own white dresses against the singing breeze of the fans.\n\n\u201cWe can\u2019t move,\u201d they said together.\n\nJordan\u2019s fingers, powdered white over their tan, rested for a moment\nin mine.\n\n\u201cAnd Mr. Thomas Buchanan, the athlete?\u201d I inquired.\n\nSimultaneously I heard his voice, gruff, muffled, husky, at the hall\ntelephone.\n\nGatsby stood in the centre of the crimson carpet and gazed around with\nfascinated eyes. Daisy watched him and laughed, her sweet, exciting\nlaugh; a tiny gust of powder rose from her bosom into the air.\n\n\u201cThe rumour is,\u201d whispered Jordan, \u201cthat that\u2019s Tom\u2019s girl on the\ntelephone.\u201d\n\nWe were silent. The voice in the hall rose high with annoyance: \u201cVery\nwell, then, I won\u2019t sell you the car at all \u2026 I\u2019m under no obligations\nto you at all \u2026 and as for your bothering me about it at lunch time, I\nwon\u2019t stand that at all!\u201d\n\n\u201cHolding down the receiver,\u201d said Daisy cynically.\n\n\u201cNo, he\u2019s not,\u201d I assured her. \u201cIt\u2019s a bona-fide deal. I happen to\nknow about it.\u201d\n\nTom flung open the door, blocked out its space for a moment with his\nthick body, and hurried into the room.\n\n\u201cMr. Gatsby!\u201d He put out his broad, flat hand with well-concealed\ndislike. \u201cI\u2019m glad to see you, sir \u2026 Nick \u2026\u201d\n\n\u201cMake us a cold drink,\u201d cried Daisy.\n\nAs he left the room again she got up and went over to Gatsby and\npulled his face\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"What did Gatsby want Daisy to do in front of Tom?\",\n    vector\\_top\\_k\\=10,\n    reranker\\_top\\_n\\=3,\n    with\\_reranker\\=True,\n)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 14 tokens\n> \\[retrieve\\] Total embedding token usage: 14 tokens\nDoc: 2, Relevance: 10\nNo relevant documents found. Please provide a different question.\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n\\*\\*\\*\\*Score\\*\\*\\*\\*: 10.0\n\\*\\*\\*\\*Node text\\*\\*\\*\\*\n: to keep your\nshoes dry?\u201d There was a husky tenderness in his tone \u2026 \u201cDaisy?\u201d\n\n\u201cPlease don\u2019t.\u201d Her voice was cold, but the rancour was gone from it.\nShe looked at Gatsby. \u201cThere, Jay,\u201d she said\u2014but her hand as she tried\nto light a cigarette was trembling. Suddenly she threw the cigarette\nand the burning match on the carpet.\n\n\u201cOh, you want too much!\u201d she cried to Gatsby. \u201cI love you now\u2014isn\u2019t\nthat enough? I can\u2019t help what\u2019s past.\u201d She began to sob\nhelplessly. \u201cI did love him once\u2014but I loved you too.\u201d\n\nGatsby\u2019s eyes opened and closed.\n\n\u201cYou loved me too?\u201d he repeated.\n\n\u201cEven that\u2019s a lie,\u201d said Tom savagely. \u201cShe didn\u2019t know you were\nalive. Why\u2014there\u2019s things between Daisy and me that you\u2019ll never know,\nthings that neither of us can ever forget.\u201d\n\nThe words seemed to bite physically into Gatsby.\n\n\u201cI want to speak to Daisy alone,\u201d he insisted. \u201cShe\u2019s all excited\nnow\u2014\u201d\n\n\u201cEven alone I can\u2019t say I never loved Tom,\u201d she admitted in a pitiful\nvoice. \u201cIt wouldn\u2019t be true.\u201d\n\n\u201cOf course it wouldn\u2019t,\u201d agreed Tom.\n\nShe turned to her husband.\n\n\u201cAs if it mattered to you,\u201d she said.\n\n\u201cOf course it matters. I\u2019m going to take better care of you from now\non.\u201d\n\n\u201cYou don\u2019t understand,\u201d said Gatsby, with a touch of panic. \u201cYou\u2019re\nnot going to take care of her any more.\u201d\n\n\u201cI\u2019m not?\u201d Tom opened his eyes wide and"
}