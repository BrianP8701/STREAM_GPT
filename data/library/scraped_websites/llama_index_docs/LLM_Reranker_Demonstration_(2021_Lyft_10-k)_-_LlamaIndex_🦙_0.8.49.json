{
    "metadata": {
        "type": "web",
        "url": "https://docs.llamaindex.ai/en/stable/examples/node_postprocessor/LLMReranker-Lyft-10k.html",
        "title": "LLM Reranker Demonstration (2021 Lyft 10-k) - LlamaIndex \ud83e\udd99 0.8.49",
        "description": null
    },
    "text": "Toggle table of contents sidebar\n\nThis tutorial showcases how to do a two-stage pass for retrieval. Use embedding-based retrieval with a high top-k value in order to maximize recall and get a large set of candidate items. Then, use LLM-based retrieval to dynamically select the nodes that are actually relevant to the query.\n\nimport nest\\_asyncio\n\nnest\\_asyncio.apply()\n\nimport logging\nimport sys\n\nlogging.basicConfig(stream\\=sys.stdout, level\\=logging.INFO)\nlogging.getLogger().addHandler(logging.StreamHandler(stream\\=sys.stdout))\nfrom llama\\_index import (\n    VectorStoreIndex,\n    SimpleDirectoryReader,\n    ServiceContext,\n    LLMPredictor,\n)\nfrom llama\\_index.indices.postprocessor import LLMRerank\n\nfrom llama\\_index.llms import OpenAI\nfrom IPython.display import Markdown, display\n\n## Load Data, Build Index[\uf0c1](#load-data-build-index \"Permalink to this heading\")\n\n\\# LLM Predictor (gpt-3.5-turbo) + service context\nllm \\= OpenAI(temperature\\=0, model\\=\"gpt-3.5-turbo\")\n\nchunk\\_overlap \\= 0\nchunk\\_size \\= 128\n\nservice\\_context \\= ServiceContext.from\\_defaults(\n    llm\\=llm,\n    chunk\\_size\\=chunk\\_size,\n    chunk\\_overlap\\=chunk\\_overlap,\n)\n\n\\# load documents\ndocuments \\= SimpleDirectoryReader(input\\_files\\=\\[\"lyft\\_10k.pdf\"\\]).load\\_data()\n\nindex \\= VectorStoreIndex.from\\_documents(\n    documents, service\\_context\\=service\\_context\n)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\n> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\n> \\[build\\_index\\_from\\_nodes\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 226241 tokens\n> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 226241 tokens\n> \\[build\\_index\\_from\\_nodes\\] Total embedding token usage: 226241 tokens\n\n## Retrieval Comparisons[\uf0c1](#retrieval-comparisons \"Permalink to this heading\")\n\nfrom llama\\_index.retrievers import VectorIndexRetriever\nfrom llama\\_index.indices.query.schema import QueryBundle\nimport pandas as pd\nfrom IPython.display import display, HTML\nfrom copy import deepcopy\n\npd.set\\_option(\"display.max\\_colwidth\", \\-1)\n\ndef get\\_retrieved\\_nodes(\n    query\\_str, vector\\_top\\_k\\=10, reranker\\_top\\_n\\=3, with\\_reranker\\=False\n):\n    query\\_bundle \\= QueryBundle(query\\_str)\n    \\# configure retriever\n    retriever \\= VectorIndexRetriever(\n        index\\=index,\n        similarity\\_top\\_k\\=vector\\_top\\_k,\n    )\n    retrieved\\_nodes \\= retriever.retrieve(query\\_bundle)\n\n    if with\\_reranker:\n        \\# configure reranker\n        reranker \\= LLMRerank(\n            choice\\_batch\\_size\\=5,\n            top\\_n\\=reranker\\_top\\_n,\n            service\\_context\\=service\\_context,\n        )\n        retrieved\\_nodes \\= reranker.postprocess\\_nodes(\n            retrieved\\_nodes, query\\_bundle\n        )\n\n    return retrieved\\_nodes\n\ndef pretty\\_print(df):\n    return display(HTML(df.to\\_html().replace(\"\\\\\\\\n\", \"<br>\")))\n\ndef visualize\\_retrieved\\_nodes(nodes) \\-> None:\n    result\\_dicts \\= \\[\\]\n    for node in nodes:\n        node \\= deepcopy(node)\n        node.node.metadata \\= None\n        node\\_text \\= node.node.get\\_text()\n        node\\_text \\= node\\_text.replace(\"\\\\n\", \" \")\n\n        result\\_dict \\= {\"Score\": node.score, \"Text\": node\\_text}\n        result\\_dicts.append(result\\_dict)\n\n    pretty\\_print(pd.DataFrame(result\\_dicts))\n\n/var/folders/1r/c3h91d9s49xblwfvz79s78\\_c0000gn/T/ipykernel\\_58458/2502541873.py:8: FutureWarning: Passing a negative integer is deprecated in version 1.0 and will not be supported in future version. Instead, use None to not limit the column width.\n  pd.set\\_option('display.max\\_colwidth', -1)\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"What is Lyft's response to COVID-19?\", vector\\_top\\_k\\=5, with\\_reranker\\=False\n)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n|     | Score | Text |\n| --- | --- | --- |\n| 0   | 0.863554 | Rentals. Further, COVID-19 has and may continue to negatively impact Lyft\u2019s ability to conduct rental operationsthrough the Express Drive program and Lyft Rentals as a result of restrictions on travel, mandated closures, limited staffing availability, and other factors relatedto COVID-19. For example, in 2020, Lyft Rentals temporarily ceased operations, closing its rental locations, as a result of COVID-19. Further, while ExpressDrive rental periods |\n| 1   | 0.854175 | pandemic, including sales, marketing and costs relating to our efforts to mitigate the impact of the COVID-19 pandemic. Furthermore, we have expanded overtime to include more asset-intensive offerings such as our network of Light Vehicles, Flexdrive, Lyft Rentals and Lyft Auto Care. We are also expanding the supportavailable to drivers at our Driver Hubs, our driver-centric service centers and community spaces, Driver Centers, our vehicle service centers, Mobile Services, |\n| 2   | 0.852866 | requested to quarantine by a medical professional, which it continues to do at this time. Further, Lyft Rentals and Flexdrive have facedsignificantly higher cos ts in transporting, repossessing, cleaning, and17 |\n| 3   | 0.847151 | the transport ation needs of customers, employees and other constituents.\u2022 Grow Active Riders. We see opportunities to continue to recoup and grow our rider base amid the continuing COVID-19 pandemic. We may make incrementalinvestments in our brand and in growth marketing to maintain and drive increasing consumer preference for Lyft. We may also offer discounts for first-time ridersto try Lyft or provide incentives to existing riders to encourage increased ride frequency. We |\n| 4   | 0.841177 | day one, we have worked continuousl y to enhance the safety of our platform and the ridesharing industry by developing innovative products, policiesand processes. Business Lyft is evolving how businesses large and small take care of their people\u2019s transportation needs across sectors including corporate, healthcare, auto, education andgovernment. Our comprehensive set of solutions allows clients to design, manage and pay for ground |\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"What is Lyft's response to COVID-19?\",\n    vector\\_top\\_k\\=20,\n    reranker\\_top\\_n\\=5,\n    with\\_reranker\\=True,\n)\n\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\n> \\[retrieve\\] Total LLM token usage: 0 tokens\nINFO:llama\\_index.token\\_counter.token\\_counter:> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n> \\[retrieve\\] Total embedding token usage: 11 tokens\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n|     | Score | Text |\n| --- | --- | --- |\n| 0   | 10.0 | inunrestricted cash and cash equivalents and short-term investments as of December 31, 2021, we believe we have sufficient liquidity to continue business operations and totake action we determine to be in the best interests of our employees, stockholders, stakeholders and of drivers and riders on the Lyft Platform. For more information onrisks associated with the COVID-19 pandem ic, see the section titled \u201cRisk Factors\u201d in Item 1A of Part I.Recent Developments Transaction |\n| 1   | 10.0 | COVID-19, may continue to develop or persist over time and further contribute to thisadverse effect. \u2022 Changes in driver behavior during the COVID-19 pandemic have led to reduced levels of driver availability on our platform relative to rider demand in certainmarkets. This imbalance fluctuates for various reasons, and to the extent that driver availability is limited, our service levels have been and may be negativelyimpacted and we have increased prices or provided additional incentives and may need to continue to do so, which |\n| 2   | 10.0 | estimated.In response to the COVID-19 pandemic, we have adopted multiple measures, including, but not limited, to establishing new health and safety requirements forridesharing and updating workplace policies. We also made adjustments to our expenses and cash flow to correlate with declines in revenues including headcountreductions in 2020. 56 |\n| 3   | 10.0 | opportunities for drivers on our platform. Our business continues to be impacted by the COVID-19pandemic. Although we have seen some signs of demand improving, particularly compared to the demand levels at the start of the pandemic, demand levels continue to beaffected by the impact of variants and changes in case counts. The exact timing and pace of the recovery remain uncertain. The extent to which our operations will continueto be impacted by the pandemic will depend largely on future |\n| 4   | 10.0 | does not perceive ridesharing or our other offerings as beneficial, or chooses not to adopt them as a result of concerns regarding public health or safety, affordability or forother reasons, whether as a result of incidents on our platform or on our competitors\u2019 platforms, the COVID-19 pandemic, or otherwise, then the market for our offeringsmay not further develop, may develop more slowly than we expect or may not achieve the growth potential we expect. Additionally, |\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"What initiatives are the company focusing on independently of COVID-19?\",\n    vector\\_top\\_k\\=5,\n    with\\_reranker\\=False,\n)\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n|     | Score | Text |\n| --- | --- | --- |\n| 0   | 0.819209 | businesses to contain the pandemic or respond to its impact and altered consumer behavior, amongother things. The Company has adopted a number of measures in response to the COVID-19 pandemic including, but not limited to, establishing new health and safetyrequirements for ridesharing and updating workplace policies. The Company also made adjustments to its expenses and cash flow to correlate with declines in revenuesincluding headcount reductions in 2020. Refer to Note 17 \u201cRestructuring\u201d to the |\n| 1   | 0.813341 | business;\u2022 manage our platform and our business assets and expenses in light of the COVID-19 pandemic and related public health measures issued by various jurisdictions,including travel bans, travel restrictions and shelter-in-place orders, as well as maintain demand for and confidence in the safety of our platform during andfollowing the COVID-19 pandemic; \u2022 plan for and manage capital |\n| 2   | 0.809412 | pandemic, including sales, marketing and costs relating to our efforts to mitigate the impact of the COVID-19 pandemic. Furthermore, we have expanded overtime to include more asset-intensive offerings such as our network of Light Vehicles, Flexdrive, Lyft Rentals and Lyft Auto Care. We are also expanding the supportavailable to drivers at our Driver Hubs, our driver-centric service centers and community spaces, Driver Centers, our vehicle service centers, Mobile Services, |\n| 3   | 0.809215 | COVID-19 pandemic in March 2020. We have adoptedmultiple measures in response to the COVID-19 pandemic. We cannot be certain that these actions will mitigate some or all of the negative effects of the pandemic on ourbusiness. In light of the evolving and unpredictable effects of COVID-19, we are not currently in a position to forecast the expected impact of COVID-19 on our financialand operating results in fu ture periods.Revenue Recognition Revenue |\n| 4   | 0.808421 | estimated.In response to the COVID-19 pandemic, we have adopted multiple measures, including, but not limited, to establishing new health and safety requirements forridesharing and updating workplace policies. We also made adjustments to our expenses and cash flow to correlate with declines in revenues including headcountreductions in 2020. 56 |\n\nnew\\_nodes \\= get\\_retrieved\\_nodes(\n    \"What initiatives are the company focusing on independently of COVID-19?\",\n    vector\\_top\\_k\\=40,\n    reranker\\_top\\_n\\=5,\n    with\\_reranker\\=True,\n)\n\nvisualize\\_retrieved\\_nodes(new\\_nodes)\n\n|     | Score | Text |\n| --- | --- | --- |\n| 0   | 10.0 | remotely, as well as permanent return to workarrangements and workplac e strategies;\u2022 the inability to achieve adherence to our internal policies and core values, including our diversity, equity and inclusion practices and initiatives;\u2022 competitive pressures to move in directions that may divert us from our mission, vision and values;\u2022 the continued challenges of a rapidly-evolving industry;\u2022 the increasing need to develop expertise in new areas of business that |\n| 1   | 9.0 | platfor m and scaled user network.Notwithstanding the impact of COVID-19, we are continuing to invest in the future, both organically and through acquisitions of complementary businesses. Wealso continue to invest in the expansion of our network of Light Vehicles and Lyft Autonomous, which focuses on the deployment and scaling of third-party self-drivingtechnology on the Lyft network. Our strategy is to always be at the forefront of transportation innovation, and we believe that through these |\n| 2   | 9.0 | the transport ation needs of customers, employees and other constituents.\u2022 Grow Active Riders. We see opportunities to continue to recoup and grow our rider base amid the continuing COVID-19 pandemic. We may make incrementalinvestments in our brand and in growth marketing to maintain and drive increasing consumer preference for Lyft. We may also offer discounts for first-time ridersto try Lyft or provide incentives to existing riders to encourage increased ride frequency. We |\n| 3   | 8.0 | to grow our business and improve ourofferings, we will face challenges related to providing quality support services at scale. If we grow our international rider base and the number of international drivers onour platform, our support organization will face additional challenges, including those associated with delivering support in languages other than English. Furthermore, theCOVID-19 pandemic may impact our ability to provide effective and timely support, including as a result of a decrease in the availability of service providers and increasein |\n| 4   | 6.0 | pandemic and responsive measures;\u2022 natural disasters, economic downturns, public health crises or political crises;\u2022 general macroeconomic conditions;Operational factors \u2022 our limited operating history;\u2022 our financial performance and any inability to achieve or maintain profitability in the future;\u2022 competition in our industries;\u2022 the unpredictability of our results of operations;\u2022 uncertainty regarding the growth of the ridesharing and other markets;\u2022 our ability to attract and |"
}